(function(){var K=this,C=K.Backbone,B=Array.prototype.slice,n=Array.prototype.splice,M;M="undefined"!==typeof exports?exports:K.Backbone={};M.VERSION="0.9.1";var N=K._;!N&&"undefined"!==typeof require&&(N=require("underscore"));var L=K.jQuery||K.Zepto||K.ender;M.setDomLibrary=function(f){L=f};M.noConflict=function(){K.Backbone=C;return this};M.emulateHTTP=!1;M.emulateJSON=!1;M.Events={on:function(h,g,m){for(var l,h=h.split(/\s+/),j=this._callbacks||(this._callbacks={});l=h.shift();){l=j[l]||(j[l]={});var i=l.tail||(l.tail=l.next={});i.callback=g;i.context=m;l.tail=i.next={}}return this},off:function(h,g,m){var l,j,i;if(h){if(j=this._callbacks){for(h=h.split(/\s+/);l=h.shift();){if(i=j[l],delete j[l],g&&i){for(;(i=i.next)&&i.next;){if(!(i.callback===g&&(!m||i.context===m))){this.on(l,i.callback,i.context)}}}}}}else{delete this._callbacks}return this},trigger:function(g){var f,j,i,h;if(!(i=this._callbacks)){return this}h=i.all;for((g=g.split(/\s+/)).push(null);f=g.shift();){h&&g.push({next:h.next,tail:h.tail,event:f}),(j=i[f])&&g.push({next:j.next,tail:j.tail})}for(h=B.call(arguments,1);j=g.pop();){f=j.tail;for(i=j.event?[j.event].concat(h):h;(j=j.next)!==f;){j.callback.apply(j.context||this,i)}}return this}};M.Events.bind=M.Events.on;M.Events.unbind=M.Events.off;M.Model=function(g,f){var h;g||(g={});f&&f.parse&&(g=this.parse(g));if(h=J(this,"defaults")){g=N.extend({},h,g)}f&&f.collection&&(this.collection=f.collection);this.attributes={};this._escapedAttributes={};this.cid=N.uniqueId("c");if(!this.set(g,{silent:!0})){throw Error("Can't create an invalid model")}delete this._changed;this._previousAttributes=N.clone(this.attributes);this.initialize.apply(this,arguments)};N.extend(M.Model.prototype,M.Events,{idAttribute:"id",initialize:function(){},toJSON:function(){return N.clone(this.attributes)},get:function(f){return this.attributes[f]},escape:function(g){var f;if(f=this._escapedAttributes[g]){return f}f=this.attributes[g];return this._escapedAttributes[g]=N.escape(null==f?"":""+f)},has:function(f){return null!=this.attributes[f]},set:function(g,f,p){var m,l;N.isObject(g)||null==g?(m=g,p=f):(m={},m[g]=f);p||(p={});if(!m){return this}m instanceof M.Model&&(m=m.attributes);if(p.unset){for(l in m){m[l]=void 0}}if(!this._validate(m,p)){return !1}this.idAttribute in m&&(this.id=m[this.idAttribute]);var f=this.attributes,i=this._escapedAttributes,o=this._previousAttributes||{},j=this._setting;this._changed||(this._changed={});this._setting=!0;for(l in m){if(g=m[l],N.isEqual(f[l],g)||delete i[l],p.unset?delete f[l]:f[l]=g,this._changing&&!N.isEqual(this._changed[l],g)&&(this.trigger("change:"+l,this,g,p),this._moreChanges=!0),delete this._changed[l],!N.isEqual(o[l],g)||N.has(f,l)!=N.has(o,l)){this._changed[l]=g}}j||(!p.silent&&this.hasChanged()&&this.change(p),this._setting=!1);return this},unset:function(g,f){(f||(f={})).unset=!0;return this.set(g,null,f)},clear:function(f){(f||(f={})).unset=!0;return this.set(N.clone(this.attributes),f)},fetch:function(g){var g=g?N.clone(g):{},f=this,h=g.success;g.success=function(l,j,i){if(!f.set(f.parse(l,i),g)){return !1}h&&h(f,l)};g.error=M.wrapError(g.error,f,g);return(this.sync||M.sync).call(this,"read",this,g)},save:function(g,f,o){var m,l;N.isObject(g)||null==g?(m=g,o=f):(m={},m[g]=f);o=o?N.clone(o):{};o.wait&&(l=N.clone(this.attributes));g=N.extend({},o,{silent:!0});if(m&&!this.set(m,o.wait?g:o)){return !1}var i=this,j=o.success;o.success=function(p,h,q){h=i.parse(p,q);o.wait&&(h=N.extend(m||{},h));if(!i.set(h,o)){return !1}j?j(i,p):i.trigger("sync",i,p,o)};o.error=M.wrapError(o.error,i,o);f=this.isNew()?"create":"update";f=(this.sync||M.sync).call(this,f,this,o);o.wait&&this.set(l,g);return f},destroy:function(g){var g=g?N.clone(g):{},f=this,j=g.success,i=function(){f.trigger("destroy",f,f.collection,g)};if(this.isNew()){return i()}g.success=function(l){g.wait&&i();j?j(f,l):f.trigger("sync",f,l,g)};g.error=M.wrapError(g.error,f,g);var h=(this.sync||M.sync).call(this,"delete",this,g);g.wait||i();return h},url:function(){var f=J(this.collection,"url")||J(this,"urlRoot")||G();return this.isNew()?f:f+("/"==f.charAt(f.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(f){return f},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(g){if(this._changing||!this.hasChanged()){return this}this._moreChanges=this._changing=!0;for(var f in this._changed){this.trigger("change:"+f,this,this._changed[f],g)}for(;this._moreChanges;){this._moreChanges=!1,this.trigger("change",this,g)}this._previousAttributes=N.clone(this.attributes);delete this._changed;this._changing=!1;return this},hasChanged:function(f){return !arguments.length?!N.isEmpty(this._changed):this._changed&&N.has(this._changed,f)},changedAttributes:function(g){if(!g){return this.hasChanged()?N.clone(this._changed):!1}var f,j=!1,i=this._previousAttributes,h;for(h in g){if(!N.isEqual(i[h],f=g[h])){(j||(j={}))[h]=f}}return j},previous:function(f){return !arguments.length||!this._previousAttributes?null:this._previousAttributes[f]},previousAttributes:function(){return N.clone(this._previousAttributes)},isValid:function(){return !this.validate(this.attributes)},_validate:function(g,f){if(f.silent||!this.validate){return !0}var g=N.extend({},this.attributes,g),h=this.validate(g,f);if(!h){return !0}f&&f.error?f.error(this,h,f):this.trigger("error",this,h,f);return !1}});M.Collection=function(g,f){f||(f={});f.comparator&&(this.comparator=f.comparator);this._reset();this.initialize.apply(this,arguments);g&&this.reset(g,{silent:!0,parse:f.parse})};N.extend(M.Collection.prototype,M.Events,{model:M.Model,initialize:function(){},toJSON:function(){return this.map(function(f){return f.toJSON()})},add:function(t,s){var r,q,p,o,m,l={},f={};s||(s={});t=N.isArray(t)?t.slice():[t];for(r=0,q=t.length;r<q;r++){if(!(p=t[r]=this._prepareModel(t[r],s))){throw Error("Can't add an invalid model to a collection")}if(l[o=p.cid]||this._byCid[o]||null!=(m=p.id)&&(f[m]||this._byId[m])){throw Error("Can't add the same model to a collection twice")}l[o]=f[m]=p}for(r=0;r<q;r++){(p=t[r]).on("all",this._onModelEvent,this),this._byCid[p.cid]=p,null!=p.id&&(this._byId[p.id]=p)}this.length+=q;n.apply(this.models,[null!=s.at?s.at:this.models.length,0].concat(t));this.comparator&&this.sort({silent:!0});if(s.silent){return this}for(r=0,q=this.models.length;r<q;r++){if(l[(p=this.models[r]).cid]){s.index=r,p.trigger("add",p,this,s)}}return this},remove:function(h,f){var m,l,j,i;f||(f={});h=N.isArray(h)?h.slice():[h];for(m=0,l=h.length;m<l;m++){if(i=this.getByCid(h[m])||this.get(h[m])){delete this._byId[i.id],delete this._byCid[i.cid],j=this.indexOf(i),this.models.splice(j,1),this.length--,f.silent||(f.index=j,i.trigger("remove",i,this,f)),this._removeReference(i)}}return this},get:function(f){return null==f?null:this._byId[null!=f.id?f.id:f]},getByCid:function(f){return f&&this._byCid[f.cid||f]},at:function(f){return this.models[f]},sort:function(g){g||(g={});if(!this.comparator){throw Error("Cannot sort a set without a comparator")}var f=N.bind(this.comparator,this);1==this.comparator.length?this.models=this.sortBy(f):this.models.sort(f);g.silent||this.trigger("reset",this,g);return this},pluck:function(f){return N.map(this.models,function(g){return g.get(f)})},reset:function(g,f){g||(g=[]);f||(f={});for(var i=0,h=this.models.length;i<h;i++){this._removeReference(this.models[i])}this._reset();this.add(g,{silent:!0,parse:f.parse});f.silent||this.trigger("reset",this,f);return this},fetch:function(g){g=g?N.clone(g):{};void 0===g.parse&&(g.parse=!0);var f=this,h=g.success;g.success=function(l,j,i){f[g.add?"add":"reset"](f.parse(l,i),g);h&&h(f,l)};g.error=M.wrapError(g.error,f,g);return(this.sync||M.sync).call(this,"read",this,g)},create:function(g,f){var i=this,f=f?N.clone(f):{},g=this._prepareModel(g,f);if(!g){return !1}f.wait||i.add(g,f);var h=f.success;f.success=function(l,j){f.wait&&i.add(l,f);h?h(l,j):l.trigger("sync",g,j,f)};g.save(null,f);return g},parse:function(f){return f},chain:function(){return N(this.models).chain()},_reset:function(){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(g,f){g instanceof M.Model?g.collection||(g.collection=this):(f.collection=this,g=new this.model(g,f),g._validate(g.attributes,f)||(g=!1));return g},_removeReference:function(f){this==f.collection&&delete f.collection;f.off("all",this._onModelEvent,this)},_onModelEvent:function(g,f,i,h){("add"==g||"remove"==g)&&i!=this||("destroy"==g&&this.remove(f,h),f&&g==="change:"+f.idAttribute&&(delete this._byId[f.previous(f.idAttribute)],this._byId[f.id]=f),this.trigger.apply(this,arguments))}});N.each("forEach,each,map,reduce,reduceRight,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortBy,sortedIndex,toArray,size,first,initial,rest,last,without,indexOf,shuffle,lastIndexOf,isEmpty,groupBy".split(","),function(f){M.Collection.prototype[f]=function(){return N[f].apply(N,[this.models].concat(N.toArray(arguments)))}});M.Router=function(f){f||(f={});f.routes&&(this.routes=f.routes);this._bindRoutes();this.initialize.apply(this,arguments)};var k=/:\w+/g,e=/\*\w+/g,d=/[-[\]{}()+?.,\\^$|#\s]/g;N.extend(M.Router.prototype,M.Events,{initialize:function(){},route:function(g,f,h){M.history||(M.history=new M.History);N.isRegExp(g)||(g=this._routeToRegExp(g));h||(h=this[f]);M.history.route(g,N.bind(function(i){i=this._extractParameters(g,i);h&&h.apply(this,i);this.trigger.apply(this,["route:"+f].concat(i));M.history.trigger("route",this,f,i)},this));return this},navigate:function(g,f){M.history.navigate(g,f)},_bindRoutes:function(){if(this.routes){var g=[],f;for(f in this.routes){g.unshift([f,this.routes[f]])}f=0;for(var h=g.length;f<h;f++){this.route(g[f][0],g[f][1],this[g[f][1]])}}},_routeToRegExp:function(f){f=f.replace(d,"\\$&").replace(k,"([^/]+)").replace(e,"(.*?)");return RegExp("^"+f+"$")},_extractParameters:function(g,f){return g.exec(f).slice(1)}});M.History=function(){this.handlers=[];N.bindAll(this,"checkUrl")};var H=/^[#\/]/,c=/msie [\w.]+/,I=!1;N.extend(M.History.prototype,M.Events,{interval:50,getFragment:function(g,f){if(null==g){if(this._hasPushState||f){var g=window.location.pathname,h=window.location.search;h&&(g+=h)}else{g=window.location.hash}}g=decodeURIComponent(g);g.indexOf(this.options.root)||(g=g.substr(this.options.root.length));return g.replace(H,"")},start:function(g){if(I){throw Error("Backbone.history has already been started")}this.options=N.extend({},{root:"/"},this.options,g);this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!(!this.options.pushState||!window.history||!window.history.pushState);var g=this.getFragment(),f=document.documentMode;if(f=c.exec(navigator.userAgent.toLowerCase())&&(!f||7>=f)){this.iframe=L('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(g)}this._hasPushState?L(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange" in window&&!f?L(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));this.fragment=g;I=!0;g=window.location;f=g.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!f){return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0}this._wantsPushState&&this._hasPushState&&f&&g.hash&&(this.fragment=g.hash.replace(H,""),window.history.replaceState({},document.title,g.protocol+"//"+g.host+this.options.root+this.fragment));if(!this.options.silent){return this.loadUrl()}},stop:function(){L(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);I=!1},route:function(g,f){this.handlers.unshift({route:g,callback:f})},checkUrl:function(){var f=this.getFragment();f==this.fragment&&this.iframe&&(f=this.getFragment(this.iframe.location.hash));if(f==this.fragment||f==decodeURIComponent(this.fragment)){return !1}this.iframe&&this.navigate(f);this.loadUrl()||this.loadUrl(window.location.hash)},loadUrl:function(g){var f=this.fragment=this.getFragment(g);return N.any(this.handlers,function(h){if(h.route.test(f)){return h.callback(f),!0}})},navigate:function(g,f){if(!I){return !1}if(!f||!0===f){f={trigger:f}}var h=(g||"").replace(H,"");this.fragment==h||this.fragment==decodeURIComponent(h)||(this._hasPushState?(0!=h.indexOf(this.options.root)&&(h=this.options.root+h),this.fragment=h,window.history[f.replace?"replaceState":"pushState"]({},document.title,h)):this._wantsHashChange?(this.fragment=h,this._updateHash(window.location,h,f.replace),this.iframe&&h!=this.getFragment(this.iframe.location.hash)&&(f.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,h,f.replace))):window.location.assign(this.options.root+g),f.trigger&&this.loadUrl(g))},_updateHash:function(g,f,h){h?g.replace(g.toString().replace(/(javascript:|#).*$/,"")+"#"+f):g.hash=f}});M.View=function(f){this.cid=N.uniqueId("view");this._configure(f||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var b=/^(\S+)\s*(.*)$/,F="model,collection,el,id,attributes,className,tagName".split(",");N.extend(M.View.prototype,M.Events,{tagName:"div",$:function(f){return this.$el.find(f)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(g,f,h){g=document.createElement(g);f&&L(g).attr(f);h&&L(g).html(h);return g},setElement:function(g,f){this.$el=L(g);this.el=this.$el[0];!1!==f&&this.delegateEvents();return this},delegateEvents:function(g){if(g||(g=J(this,"events"))){this.undelegateEvents();for(var f in g){var j=g[f];N.isFunction(j)||(j=this[g[f]]);if(!j){throw Error('Event "'+g[f]+'" does not exist')}var i=f.match(b),h=i[1],i=i[2],j=N.bind(j,this),h=h+(".delegateEvents"+this.cid);""===i?this.$el.bind(h,j):this.$el.delegate(i,h,j)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(g){this.options&&(g=N.extend({},this.options,g));for(var f=0,i=F.length;f<i;f++){var h=F[f];g[h]&&(this[h]=g[h])}this.options=g},_ensureElement:function(){if(this.el){this.setElement(this.el,!1)}else{var f=J(this,"attributes")||{};this.id&&(f.id=this.id);this.className&&(f["class"]=this.className);this.setElement(this.make(this.tagName,f),!1)}}});M.Model.extend=M.Collection.extend=M.Router.extend=M.View.extend=function(g,f){var h=a(this,g,f);h.extend=this.extend;return h};var E={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};M.sync=function(g,f,j){var i=E[g],h={type:i,dataType:"json"};j.url||(h.url=J(f,"url")||G());if(!j.data&&f&&("create"==g||"update"==g)){h.contentType="application/json",h.data=JSON.stringify(f.toJSON())}M.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{});if(M.emulateHTTP&&("PUT"===i||"DELETE"===i)){M.emulateJSON&&(h.data._method=i),h.type="POST",h.beforeSend=function(l){l.setRequestHeader("X-HTTP-Method-Override",i)}}"GET"!==h.type&&!M.emulateJSON&&(h.processData=!1);return L.ajax(N.extend(h,j))};M.wrapError=function(g,f,h){return function(j,i){i=j===f?i:j;g?g(f,i,h):f.trigger("error",f,i,h)}};var D=function(){},a=function(g,f,i){var h;h=f&&f.hasOwnProperty("constructor")?f.constructor:function(){g.apply(this,arguments)};N.extend(h,g);D.prototype=g.prototype;h.prototype=new D;f&&N.extend(h.prototype,f);i&&N.extend(h,i);h.prototype.constructor=h;h.__super__=g.prototype;return h},J=function(g,f){return !g||!g[f]?null:N.isFunction(g[f])?g[f]():g[f]},G=function(){throw Error('A "url" property or function must be specified')}}).call(this);