define("tinymce/file/Uploader",["tinymce/util/Promise","tinymce/util/Tools","tinymce/util/Fun"],function(b,a,c){return function(e,f){var r={};function i(t){var v,u;u={"image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/png":"png"};v=u[t.blob().type.toLowerCase()]||"dat";return t.id()+"."+v}function m(u,t){if(u){return u.replace(/\/$/,"")+"/"+t.replace(/^\//,"")}return t}function l(t){return{id:t.id,blob:t.blob,base64:t.base64,filename:c.constant(i(t))}}function g(v,y,u,t){var x,w;x=new XMLHttpRequest();x.open("POST",f.url);x.withCredentials=f.credentials;x.upload.onprogress=function(z){t(z.loaded/z.total*100)};x.onerror=function(){u("Image upload failed due to a XHR Transport error. Code: "+x.status)};x.onload=function(){var z;if(x.status!=200){u("HTTP Error: "+x.status);return}z=JSON.parse(x.responseText);if(!z||typeof z.location!="string"){u("Invalid JSON: "+x.responseText);return}y(m(f.basePath,z.location))};w=new FormData();w.append("file",v.blob(),i(v));x.send(w)}function p(){return new b(function(t){t([])})}function d(u,t){return{url:t,blobInfo:u,status:true}}function o(u,t){return{url:"",blobInfo:u,status:false,error:t}}function q(u,t){a.each(r[u],function(v){v(t)});delete r[u]}function k(u,v,t){e.markPending(u.blobUri());return new b(function(B){var C,y;var A=function(){};try{var w=function(){if(C){C.close();y=A}};var D=function(E){w();e.markUploaded(u.blobUri(),E);q(u.blobUri(),d(u,E));B(d(u,E))};var x=function(){w();e.removeFailed(u.blobUri());q(u.blobUri(),o(u,x));B(o(u,x))};y=function(E){if(E<0||E>100){return}if(!C){C=t()}C.progressBar.value(E)};v(l(u),D,x,y)}catch(z){B(o(u,z.message))}})}function h(t){return t===g}function j(t){var u=t.blobUri();return new b(function(v){r[u]=r[u]||[];r[u].push(v)})}function n(u,t){u=a.grep(u,function(v){return !e.isUploaded(v.blobUri())});return b.all(a.map(u,function(v){return e.isPending(v.blobUri())?j(v):k(v,f.handler,t)}))}function s(u,t){return(!f.url&&h(f.handler))?p():n(u,t)}f=a.extend({credentials:false,handler:g},f);return{upload:s}}});