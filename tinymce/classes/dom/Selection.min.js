define("tinymce/dom/Selection",["tinymce/dom/TreeWalker","tinymce/dom/TridentSelection","tinymce/dom/ControlSelection","tinymce/dom/RangeUtils","tinymce/dom/BookmarkManager","tinymce/dom/NodeType","tinymce/Env","tinymce/util/Tools","tinymce/caret/CaretPosition"],function(k,i,a,g,l,b,h,e,f){var j=e.each,d=e.trim;var c=h.ie;function m(r,q,p,o){var n=this;n.dom=r;n.win=q;n.serializer=p;n.editor=o;n.bookmarkManager=new l(n);n.controlSelection=new a(n,o);if(!n.win.getSelection){n.tridentSel=new i(n)}}m.prototype={setCursorLocation:function(p,q){var o=this,n=o.dom.createRng();if(!p){o._moveEndPoint(n,o.editor.getBody(),true);o.setRng(n)}else{n.setStart(p,q);n.setEnd(p,q);o.setRng(n);o.collapse(false)}},getContent:function(r){var p=this,o=p.getRng(),n=p.dom.create("body");var u=p.getSel(),t,s,q;r=r||{};t=s="";r.get=true;r.format=r.format||"html";r.selection=true;p.editor.fire("BeforeGetContent",r);if(r.format=="text"){return p.isCollapsed()?"":(o.text||(u.toString?u.toString():""))}if(o.cloneContents){q=o.cloneContents();if(q){n.appendChild(q)}}else{if(o.item!==undefined||o.htmlText!==undefined){n.innerHTML="<br>"+(o.item?o.item(0).outerHTML:o.htmlText);n.removeChild(n.firstChild)}else{n.innerHTML=o.toString()}}if(/^\s/.test(n.innerHTML)){t=" "}if(/\s+$/.test(n.innerHTML)){s=" "}r.getInner=true;r.content=p.isCollapsed()?"":t+p.serializer.serialize(n,r)+s;p.editor.fire("GetContent",r);return r.content},setContent:function(o,q){var v=this,n=v.getRng(),r,s=v.win.document,u,t;q=q||{format:"html"};q.set=true;q.selection=true;q.content=o;if(!q.no_events){v.editor.fire("BeforeSetContent",q)}o=q.content;if(n.insertNode){o+='<span id="__caret">_</span>';if(n.startContainer==s&&n.endContainer==s){s.body.innerHTML=o}else{n.deleteContents();if(s.body.childNodes.length===0){s.body.innerHTML=o}else{if(n.createContextualFragment){n.insertNode(n.createContextualFragment(o))}else{u=s.createDocumentFragment();t=s.createElement("div");u.appendChild(t);t.outerHTML=o;n.insertNode(u)}}}r=v.dom.get("__caret");n=s.createRange();n.setStartBefore(r);n.setEndBefore(r);v.setRng(n);v.dom.remove("__caret");try{v.setRng(n)}catch(p){}}else{if(n.item){s.execCommand("Delete",false,null);n=v.getRng()}if(/^\s+/.test(o)){n.pasteHTML('<span id="__mce_tmp">_</span>'+o);v.dom.remove("__mce_tmp")}else{n.pasteHTML(o)}}if(!q.no_events){v.editor.fire("SetContent",q)}},getStart:function(t){var p=this,o=p.getRng(),q,n,s,r;if(o.duplicate||o.item){if(o.item){return o.item(0)}s=o.duplicate();s.collapse(1);q=s.parentElement();if(q.ownerDocument!==p.dom.doc){q=p.dom.getRoot()}n=r=o.parentElement();while((r=r.parentNode)){if(r==q){q=n;break}}return q}q=o.startContainer;if(q.nodeType==1&&q.hasChildNodes()){if(!t||!o.collapsed){q=q.childNodes[Math.min(q.childNodes.length-1,o.startOffset)]}}if(q&&q.nodeType==3){return q.parentNode}return q},getEnd:function(r){var o=this,n=o.getRng(),q,p;if(n.duplicate||n.item){if(n.item){return n.item(0)}n=n.duplicate();n.collapse(0);q=n.parentElement();if(q.ownerDocument!==o.dom.doc){q=o.dom.getRoot()}if(q&&q.nodeName=="BODY"){return q.lastChild||q}return q}q=n.endContainer;p=n.endOffset;if(q.nodeType==1&&q.hasChildNodes()){if(!r||!n.collapsed){q=q.childNodes[p>0?p-1:p]}}if(q&&q.nodeType==3){return q.parentNode}return q},getBookmark:function(n,o){return this.bookmarkManager.getBookmark(n,o)},moveToBookmark:function(n){return this.bookmarkManager.moveToBookmark(n)},select:function(r,q){var p=this,s=p.dom,o=s.createRng(),n;p.lastFocusBookmark=null;if(r){if(!q&&p.controlSelection.controlSelect(r)){return}n=s.nodeIndex(r);o.setStart(r.parentNode,n);o.setEnd(r.parentNode,n+1);if(q){p._moveEndPoint(o,r,true);p._moveEndPoint(o,r)}p.setRng(o)}return r},isCollapsed:function(){var o=this,n=o.getRng(),p=o.getSel();if(!n||n.item){return false}if(n.compareEndPoints){return n.compareEndPoints("StartToEnd",n)===0}return !p||n.collapsed},collapse:function(p){var o=this,n=o.getRng(),q;if(n.item){q=n.item(0);n=o.win.document.body.createTextRange();n.moveToElementText(q)}n.collapse(!!p);o.setRng(n)},getSel:function(){var n=this.win;return n.getSelection?n.getSelection():n.document.selection},getRng:function(t){var x=this,v,n,r,u,p,w;function s(A,B,y){try{return B.compareBoundaryPoints(A,y)}catch(z){return -1}}if(!x.win){return null}u=x.win.document;if(!t&&x.lastFocusBookmark){var o=x.lastFocusBookmark;if(o.startContainer){n=u.createRange();n.setStart(o.startContainer,o.startOffset);n.setEnd(o.endContainer,o.endOffset)}else{n=o}return n}if(t&&x.tridentSel){return x.tridentSel.getRangeAt(0)}try{if((v=x.getSel())){if(v.rangeCount>0){n=v.getRangeAt(0)}else{n=v.createRange?v.createRange():u.createRange()}}}catch(q){}w=x.editor.fire("GetSelectionRange",{range:n});if(w.range!==n){return w.range}if(c&&n&&n.setStart&&u.selection){try{p=u.selection.createRange()}catch(q){}if(p&&p.item){r=p.item(0);n=u.createRange();n.setStartBefore(r);n.setEndAfter(r)}}if(!n){n=u.createRange?u.createRange():u.body.createTextRange()}if(n.setStart&&n.startContainer.nodeType===9&&n.collapsed){r=x.dom.getRoot();n.setStart(r,0);n.setEnd(r,0)}if(x.selectedRange&&x.explicitRange){if(s(n.START_TO_START,n,x.selectedRange)===0&&s(n.END_TO_END,n,x.selectedRange)===0){n=x.explicitRange}else{x.selectedRange=null;x.explicitRange=null}}return n},setRng:function(o,q){var p=this,t,s,n;if(!o){return}if(o.select){p.explicitRange=null;try{o.select()}catch(r){}return}if(!p.tridentSel){t=p.getSel();n=p.editor.fire("SetSelectionRange",{range:o});o=n.range;if(t){p.explicitRange=o;try{t.removeAllRanges();t.addRange(o)}catch(r){}if(q===false&&t.extend){t.collapse(o.endContainer,o.endOffset);t.extend(o.startContainer,o.startOffset)}p.selectedRange=t.rangeCount>0?t.getRangeAt(0):null}if(!o.collapsed&&o.startContainer==o.endContainer&&t.setBaseAndExtent&&!h.ie){if(o.endOffset-o.startOffset<2){if(o.startContainer.hasChildNodes()){s=o.startContainer.childNodes[o.startOffset];if(s&&s.tagName=="IMG"){p.getSel().setBaseAndExtent(s,0,s,1)}}}}}else{if(o.cloneRange){try{p.tridentSel.addRange(o)}catch(r){}}}},setNode:function(o){var n=this;n.setContent(n.dom.getOuterHTML(o));return o},getNode:function(){var u=this,n=u.getRng(),q;var o,v,r,s,t=u.dom.getRoot();function p(x,w){var y=x;while(x&&x.nodeType===3&&x.length===0){x=w?x.nextSibling:x.previousSibling}return x||y}if(!n){return t}o=n.startContainer;v=n.endContainer;r=n.startOffset;s=n.endOffset;if(n.setStart){q=n.commonAncestorContainer;if(!n.collapsed){if(o==v){if(s-r<2){if(o.hasChildNodes()){q=o.childNodes[r]}}}if(o.nodeType===3&&v.nodeType===3){if(o.length===r){o=p(o.nextSibling,true)}else{o=o.parentNode}if(s===0){v=p(v.previousSibling,false)}else{v=v.parentNode}if(o&&o===v){return o}}}if(q&&q.nodeType==3){return q.parentNode}return q}q=n.item?n.item(0):n.parentElement();if(q.ownerDocument!==u.win.document){q=t}return q},getSelectedBlocks:function(q,p){var o=this,u=o.dom,r,n,t=[];n=u.getRoot();q=u.getParent(q||o.getStart(),u.isBlock);p=u.getParent(p||o.getEnd(),u.isBlock);if(q&&q!=n){t.push(q)}if(q&&p&&q!=p){r=q;var s=new k(q,n);while((r=s.next())&&r!=p){if(u.isBlock(r)){t.push(r)}}}if(p&&q!=p&&p!=n){t.push(p)}return t},isForward:function(){var p=this.dom,n=this.getSel(),q,o;if(!n||!n.anchorNode||!n.focusNode){return true}q=p.createRng();q.setStart(n.anchorNode,n.anchorOffset);q.collapse(true);o=p.createRng();o.setStart(n.focusNode,n.focusOffset);o.collapse(true);return q.compareBoundaryPoints(q.START_TO_START,o)<=0},normalize:function(){var o=this,n=o.getRng();if(h.range&&new g(o.dom).normalize(n)){o.setRng(n,o.isForward())}return n},selectorChanged:function(n,q){var o=this,p;if(!o.selectorChangedData){o.selectorChangedData={};p={};o.editor.on("NodeChange",function(u){var t=u.element,v=o.dom,r=v.getParents(t,null,v.getRoot()),s={};j(o.selectorChangedData,function(x,w){j(r,function(y){if(v.is(y,w)){if(!p[w]){j(x,function(z){z(true,{node:y,selector:w,parents:r})});p[w]=x}s[w]=x;return false}})});j(p,function(x,w){if(!s[w]){delete p[w];j(x,function(y){y(false,{node:t,selector:w,parents:r})})}})})}if(!o.selectorChangedData[n]){o.selectorChangedData[n]=[]}o.selectorChangedData[n].push(q);return o},getScrollContainer:function(){var n,o=this.dom.getRoot();while(o&&o.nodeName!="BODY"){if(o.scrollHeight>o.clientHeight){n=o;break}o=o.parentNode}return n},scrollIntoView:function(r,v){var t,x,z=this,p=z.dom,u=p.getRoot(),n,w,q=0;function o(D){var A=0,C=0;var B=D;while(B&&B.nodeType){A+=B.offsetLeft||0;C+=B.offsetTop||0;B=B.offsetParent}return{x:A,y:C}}if(!b.isElement(r)){return}if(v===false){q=r.offsetHeight}if(u.nodeName!="BODY"){var s=z.getScrollContainer();if(s){t=o(r).y-o(s).y+q;w=s.clientHeight;n=s.scrollTop;if(t<n||t+25>n+w){s.scrollTop=t<n?t:t-w+25}return}}x=p.getViewPort(z.editor.getWin());t=p.getPos(r).y+q;n=x.y;w=x.h;if(t<x.y||t+25>n+w){z.editor.getWin().scrollTo(0,t<n?t:t-w+25)}},placeCaretAt:function(o,n){this.setRng(g.getCaretRangeFromPoint(o,n,this.editor.getDoc()))},_moveEndPoint:function(o,q,s){var n=q,r=new k(q,n);var p=this.dom.schema.getNonEmptyElements();do{if(q.nodeType==3&&d(q.nodeValue).length!==0){if(s){o.setStart(q,0)}else{o.setEnd(q,q.nodeValue.length)}return}if(p[q.nodeName]&&!/^(TD|TH)$/.test(q.nodeName)){if(s){o.setStartBefore(q)}else{if(q.nodeName=="BR"){o.setEndBefore(q)}else{o.setEndAfter(q)}}return}if(h.ie&&h.ie<11&&this.dom.isBlock(q)&&this.dom.isEmpty(q)){if(s){o.setStart(q,0)}else{o.setEnd(q,0)}return}}while((q=(s?r.next():r.prev())));if(n.nodeName=="BODY"){if(s){o.setStart(n,0)}else{o.setEnd(n,n.childNodes.length)}}},getBoundingClientRect:function(){var n=this.getRng();return n.collapsed?f.fromRangeStart(n).getClientRects()[0]:n.getBoundingClientRect()},destroy:function(){this.win=null;this.controlSelection.destroy()}};return m});