define("tinymce/dom/BookmarkManager",["tinymce/Env","tinymce/util/Tools","tinymce/caret/CaretContainer","tinymce/caret/CaretBookmark","tinymce/caret/CaretPosition","tinymce/dom/NodeType"],function(b,e,f,h,a,d){var g=d.isContentEditableFalse;function c(i){var j=i.dom;this.getBookmark=function(v,x){var l,o,n,r,m,s,q="&#xFEFF;",y;function k(z,A){var B=0;e.each(j.select(z),function(C){if(C.getAttribute("data-mce-bogus")==="all"){return}if(C==A){return false}B++});return B}function w(z){function A(F){var B,E,D,C=F?"start":"end";B=z[C+"Container"];E=z[C+"Offset"];if(B.nodeType==1&&B.nodeName=="TR"){D=B.childNodes;B=D[Math.min(F?E:E-1,D.length-1)];if(B){E=F?0:B.childNodes.length;z["set"+(F?"Start":"End")](B,E)}}}A(true);A();return z}function p(A){var z=j.getRoot(),B={};function C(F,K){var E=F[K?"startContainer":"endContainer"],J=F[K?"startOffset":"endOffset"],D=[],G,I,H=0;if(E.nodeType==3){if(x){for(G=E.previousSibling;G&&G.nodeType==3;G=G.previousSibling){J+=G.nodeValue.length}}D.push(J)}else{I=E.childNodes;if(J>=I.length&&I.length){H=1;J=Math.max(0,I.length-1)}D.push(j.nodeIndex(I[J],x)+H)}for(;E&&E!=z;E=E.parentNode){D.push(j.nodeIndex(E,x))}return D}B.start=C(A,true);if(!i.isCollapsed()){B.end=C(A)}return B}function u(z){function A(C){var B;if(f.isCaretContainer(C)){if(d.isText(C)&&f.isCaretContainerBlock(C)){C=C.parentNode}B=C.previousSibling;if(g(B)){return B}B=C.nextSibling;if(g(B)){return B}}}return A(z.startContainer)||A(z.endContainer)}if(v==2){s=i.getNode();m=s?s.nodeName:null;l=i.getRng();if(g(s)||m=="IMG"){return{name:m,index:k(m,s)}}if(i.tridentSel){return i.tridentSel.getBookmark(v)}s=u(l);if(s){m=s.tagName;return{name:m,index:k(m,s)}}return p(l)}if(v==3){l=i.getRng();return{start:h.create(j.getRoot(),a.fromRangeStart(l)),end:h.create(j.getRoot(),a.fromRangeEnd(l))}}if(v){return{rng:i.getRng()}}l=i.getRng();n=j.uniqueId();r=i.isCollapsed();y="overflow:hidden;line-height:0px";if(l.duplicate||l.item){if(!l.item){o=l.duplicate();try{l.collapse();l.pasteHTML('<span data-mce-type="bookmark" id="'+n+'_start" style="'+y+'">'+q+"</span>");if(!r){o.collapse(false);l.moveToElementText(o.parentElement());if(l.compareEndPoints("StartToEnd",o)===0){o.move("character",-1)}o.pasteHTML('<span data-mce-type="bookmark" id="'+n+'_end" style="'+y+'">'+q+"</span>")}}catch(t){return null}}else{s=l.item(0);m=s.nodeName;return{name:m,index:k(m,s)}}}else{s=i.getNode();m=s.nodeName;if(m=="IMG"){return{name:m,index:k(m,s)}}o=w(l.cloneRange());if(!r){o.collapse(false);o.insertNode(j.create("span",{"data-mce-type":"bookmark",id:n+"_end",style:y},q))}l=w(l);l.collapse(true);l.insertNode(j.create("span",{"data-mce-type":"bookmark",id:n+"_start",style:y},q))}i.moveToBookmark({id:n,keep:1});return{id:n}};this.moveToBookmark=function(p){var k,t,m,u,q,r;function l(A){var v=p[A?"start":"end"],x,y,z,w;if(v){z=v[0];for(y=t,x=v.length-1;x>=1;x--){w=y.childNodes;if(v[x]>w.length-1){return}y=w[v[x]]}if(y.nodeType===3){z=Math.min(v[0],y.nodeValue.length)}if(y.nodeType===1){z=Math.min(v[0],y.childNodes.length)}if(A){k.setStart(y,z)}else{k.setEnd(y,z)}}return true}function n(B){var w=j.get(p.id+"_"+B),A,v,y,z,x=p.keep;if(w){A=w.parentNode;if(B=="start"){if(!x){v=j.nodeIndex(w)}else{A=w.firstChild;v=1}m=u=A;q=r=v}else{if(!x){v=j.nodeIndex(w)}else{A=w.firstChild;v=1}u=A;r=v}if(!x){z=w.previousSibling;y=w.nextSibling;e.each(e.grep(w.childNodes),function(C){if(C.nodeType==3){C.nodeValue=C.nodeValue.replace(/\uFEFF/g,"")}});while((w=j.get(p.id+"_"+B))){j.remove(w,1)}if(z&&y&&z.nodeType==y.nodeType&&z.nodeType==3&&!b.opera){v=z.nodeValue.length;z.appendData(y.nodeValue);j.remove(y);if(B=="start"){m=u=z;q=r=v}else{u=z;r=v}}}}}function o(v){if(j.isBlock(v)&&!v.innerHTML&&!b.ie){v.innerHTML='<br data-mce-bogus="1" />'}return v}function s(){var v,w;v=j.createRng();w=h.resolve(j.getRoot(),p.start);v.setStart(w.container(),w.offset());w=h.resolve(j.getRoot(),p.end);v.setEnd(w.container(),w.offset());return v}if(p){if(e.isArray(p.start)){k=j.createRng();t=j.getRoot();if(i.tridentSel){return i.tridentSel.moveToBookmark(p)}if(l(true)&&l()){i.setRng(k)}}else{if(typeof p.start=="string"){i.setRng(s(p))}else{if(p.id){n("start");n("end");if(m){k=j.createRng();k.setStart(o(m),q);k.setEnd(o(u),r);i.setRng(k)}}else{if(p.name){i.select(j.select(p.name)[p.index])}else{if(p.rng){i.setRng(p.rng)}}}}}}}}c.isBookmarkNode=function(i){return i&&i.tagName==="SPAN"&&i.getAttribute("data-mce-type")==="bookmark"};return c});